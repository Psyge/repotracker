<!DOCTYPE html>
<html lang="fi">
<head>
<title>RepoTracker - Follow the northern lights </title>   
<meta name="description" content="Follow the northern lights in real time with RepoTracker. Map and northern lights forecasts">
<meta name="keywords" content="revontulet, aurora borealis, RepoTracker, s√§√§, kartta, Rovaniemi, northern lights, aurora forecast, real-time aurora">  
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RepoTracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #0000;
  }
  header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100px;
    background: #1e88e5;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 1000;
  }
  #container {
    position: absolute;
    top: 100px;
    bottom: 0;
    left: 0;
    right: 0;
  }
  #map {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
  #sidebar {
    position: absolute;
    top: 100px;
    right: 0;
    width: 250px;
    background: rgba(255, 255, 255, 0.85);
    padding: 10px;
    box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    overflow-y: auto;
    height: calc(100% - 100px);
    z-index: 1000;
  }
  .leaflet-top.leaflet-left {
    top: 100px !important;
  }
  #info {
    position: absolute;
    top: 110px;
    left: 10px;
    z-index: 1000;
    color: white;
    background: rgba(0,0,0,0.5);
    padding: 5px 10px;
    border-radius: 5px;
  }
  .loading { 
opacity: 0.7; 
}
  .error { 
color: red; 
}
.banner {
  background: url('https://psyge.github.io/repo-nimi/revontulet.png') no-repeat center center;
  background-size: cover;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  text-align: center;
  font-family: Arial, sans-serif;
}

.banner-content h1 {
  font-size: 3rem;
  margin: 0;
}

.banner-content p {
  font-size: 1.2rem;
  margin: 0;
}
</style>
</head>
<body>
<header class="banner">
  <div class="banner-content">
    
  </div>
</header>

<div id="container">
  <div id="map"></div>
  <aside id="sidebar">
   <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1393421309906207"
     crossorigin="anonymous"></script>
  </aside>
</div>
<div id="info" class="loading">‚è≥ Ladataan revontuliennustetta...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- Globaalit ---
let auroraLayer = null;
let userMarker = null;
let currentData = null;
let notificationPermissionRequested = false;

// --- Kartta ---
const map = L.map('map', {
  center: [65, 25],
  zoom: 4,
  minZoom: 2,
  maxZoom: 12,
  worldCopyJump: false
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> & <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19,
  
}).addTo(map);

// Rajoitetaan n√§kym√§ yhteen maapallon levyiseen alueeseen
map.setMaxBounds([[-90, -180], [90, 180]]);
map.on('drag', () => map.panInsideBounds([[-90, -180],[90,180]], {animate:false}));

const info = document.getElementById("info");

// --- Hae NOAA data ---
function fetchAuroraData() {
  info.className = 'loading';
  info.innerHTML = '‚è≥ Ladataan revontuliennustetta...';
  const directUrl = 'https://services.swpc.noaa.gov/json/ovation_aurora_latest.json';
  const proxyUrl = 'https://corsproxy.io/?' + directUrl;

  fetch(directUrl).catch(() => fetch(proxyUrl))
    .then(res => { if(!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
    .then(data => {
      if (!data.coordinates || !Array.isArray(data.coordinates)) throw new Error("Datassa ei ole 'coordinates'-taulukkoa");
      currentData = data;
      const obsTime = formatTime(data["Observation Time"]);
      const forecastTime = formatTime(data["Forecast Time"]);
      info.className = '';
      info.innerHTML = `<strong>üì° Revontuliennuste</strong><br>
        <small>Havainto: ${obsTime}<br>Ennuste: ${forecastTime}<br>Pisteit√§: ${data.coordinates.length}</small>`;
      drawAuroraOverlay(data.coordinates);
    })
    .catch(err => {
      console.error('Virhe haettaessa NOAA dataa:', err);
      info.className = 'error';
      info.innerHTML = `<strong>‚ùå Virhe</strong><br><small>Ei saatu revontuliennustetta.<br>${err.message}</small>`;
    });
}

function formatTime(timeStr) {
  try {
    const date = new Date(timeStr);
    return date.toLocaleString('fi-FI',{day:'numeric',month:'numeric',hour:'2-digit',minute:'2-digit'});
  } catch { return timeStr; }
}

// --- Piirr√§ revontulet gradienttina ---
// --- Piirr√§ revontulet gradienttina ymp√§ri palloa ---
// --- Piirr√§ revontulet samalla tyylill√§ kuin liitt√§m√§ss√§si ---
function drawAuroraOverlay(points) {
  if (auroraLayer) {
    auroraLayer.forEach(l => map.removeLayer(l));
  }
  auroraLayer = [];

  const canvasWidth = 3600;
  const canvasHeight = 500;

  const createCanvasOverlay = (xOffset = 0, clipStart = -Infinity, clipEnd = Infinity) => {
    const canvas = document.createElement('canvas');
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    const ctx = canvas.getContext('2d');

    points.forEach(p => {
      let lon = p[0]; 
      if (lon < 0) lon += 360; // normalize 0-360
      if (lon < clipStart || lon > clipEnd) return; // piirr√§ vain sallitulle alueelle
      const lat = p[1];
      const intensity = p[2];
      if (intensity < 1) return;

      const x = ((lon + 180) / 360) * canvasWidth + xOffset;
      const y = ((90 - lat) / 50) * canvasHeight;

      const radius = Math.min(60, Math.max(10, intensity * 3));

      const grad = ctx.createRadialGradient(x, y, 0, x, y, radius);
      grad.addColorStop(0, `rgba(50,255,100,${Math.min(0.3, intensity / 10)})`);
      grad.addColorStop(0.5, `rgba(0,200,100,${Math.min(0.1, intensity / 15)})`);
      grad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = grad;

      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI*2);
      ctx.fill();
    });

    const bounds = [[40, -180], [90, 180]];
    const overlay = L.imageOverlay(canvas.toDataURL(), bounds, { opacity: 0.75, interactive: false }).addTo(map);
    auroraLayer.push(overlay);
  };

  // piirret√§√§n kolme overlayta, mutta rajoitetaan miss√§ alueella pisteit√§ piirret√§√§n
  createCanvasOverlay(0);       // alkuper√§inen
  createCanvasOverlay(-canvasWidth); // vasen kopio
  createCanvasOverlay(canvasWidth);   // oikea kopio
  
}






// --- Tarkista k√§ytt√§j√§n sijainti ja revontulet ---
function checkAuroraAtLocation(userLat,userLon) {
  if(!currentData||!currentData.coordinates) return;
  let nearest=null,minDist=Infinity;
  currentData.coordinates.forEach(p=>{
    let lon = p[0]<0? p[0]+360:p[0];
    let lat=p[1]; let intensity=p[2];
    const latDiff = lat-userLat;
    const lonDiff = Math.abs(lon-userLon);
    const lonDiffNormalized = Math.min(lonDiff,360-lonDiff);
    const dist=Math.hypot(latDiff,lonDiffNormalized*Math.cos(userLat*Math.PI/180));
    if(dist<minDist){minDist=dist;nearest={lat,lon,intensity,distance:dist};}
  });
  if(nearest){
    let message='',emoji='';
    if(nearest.intensity>80){emoji='üåü';message=`${emoji} <strong>Vahvaa revontuliaktiivisuutta!</strong><br>Intensiteetti: ${nearest.intensity.toFixed(1)}`;}
    else if(nearest.intensity>60){emoji='üåå';message=`${emoji} <strong>Revontulia hyvin todenn√§k√∂isesti n√§kyviss√§</strong><br>Intensiteetti: ${nearest.intensity.toFixed(1)}`;}
    else if(nearest.intensity>40){emoji='‚ú®';message=`${emoji} <strong>Kohtalaista aktiivisuutta</strong><br>Intensiteetti: ${nearest.intensity.toFixed(1)}`;}
    else if(nearest.intensity>20){emoji='üåô';message=`${emoji} <strong>Heikkoa aktiivisuutta</strong><br>Intensiteetti: ${nearest.intensity.toFixed(1)}`;}
    else{emoji='üòï';message=`${emoji} <strong>Ei juuri revontulia</strong><br>Intensiteetti: ${nearest.intensity.toFixed(1)}`;}
    message+=`<br><small>Et√§isyys datapisteeseen: ~${(nearest.distance*111).toFixed(0)} km</small>`;
    L.popup().setLatLng([userLat,userLon]).setContent(message).openOn(map);
    if(Notification.permission==="granted"&&nearest.intensity>5){
      new Notification("üåå Revontuli-ilmoitus",{body:message.replace(/<[^>]*>/g,'')});
    }
  }
}

// --- K√§ytt√§j√§n sijainti ---
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    map.setView([lat,lon],5);
    userMarker=L.marker([lat,lon]).addTo(map).bindPopup('Sinun sijaintisi');
    checkAuroraAtLocation(lat,lon);
  });
}

// --- S√§√§nn√∂llinen p√§ivitys ---
fetchAuroraData();
setInterval(fetchAuroraData, 5*60*1000);
</script>
</body>
</html>




